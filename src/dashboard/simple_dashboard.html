<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project Sentinel – CX Command Center</title>
    <style>
      :root {
        color-scheme: dark light;
        --bg: #0f172a;
        --panel: rgba(30, 41, 59, 0.9);
        --card: rgba(15, 23, 42, 0.85);
        --text: #f8fafc;
        --muted: #94a3b8;
        --accent: #38bdf8;
        --border: rgba(255, 255, 255, 0.1);
        font-family: "Segoe UI", Tahoma, sans-serif;
      }

      body {
        margin: 0;
        background: linear-gradient(135deg, var(--bg), #1e293b 55%, #111827);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        padding: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, rgba(56, 189, 248, 0.2), transparent);
        border-bottom: 1px solid var(--border);
        backdrop-filter: blur(12px);
      }

      header h1 {
        margin: 0;
        font-size: clamp(1.6rem, 2.4vw, 2.8rem);
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .status-chip {
        background: rgba(34, 197, 94, 0.2);
        border: 1px solid rgba(34, 197, 94, 0.6);
        color: #bbf7d0;
        padding: 0.4rem 0.9rem;
        border-radius: 100px;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      main {
        flex: 1;
        padding: 2rem;
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        align-content: start;
      }

      section {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 1.5rem;
        box-shadow: 0 20px 35px rgba(15, 23, 42, 0.45);
        backdrop-filter: blur(8px);
      }

      section h2 {
        margin-top: 0;
        font-size: 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .cards {
        display: grid;
        gap: 1rem;
      }

      .station-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1rem 1.2rem;
        display: grid;
        gap: 0.5rem;
        position: relative;
        overflow: hidden;
        min-height: 140px;
      }

      .station-card::after {
        content: "";
        position: absolute;
        inset: 0;
        opacity: 0.14;
        background: radial-gradient(circle at top right, rgba(56, 189, 248, 0.6), transparent 55%);
      }

      .station-card .station-id {
        font-weight: 600;
        letter-spacing: 0.05em;
      }

      .station-card .metric {
        font-size: 0.95rem;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
      }

      .health-indicator {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 0 12px currentColor;
      }

      .health-optimal {
        color: #34d399;
      }

      .health-stable {
        color: #38bdf8;
      }

      .health-at-risk {
        color: #facc15;
      }

      .health-critical {
        color: #f87171;
      }

      .alert {
        border-radius: 14px;
        padding: 0.8rem 1rem;
        margin-bottom: 0.8rem;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.6);
      }

      .alert.high {
        border-color: rgba(248, 113, 113, 0.5);
        background: rgba(248, 113, 113, 0.15);
      }

      .alert.medium {
        border-color: rgba(250, 204, 21, 0.4);
        background: rgba(250, 204, 21, 0.12);
      }

      .alert.low {
        border-color: rgba(59, 130, 246, 0.35);
        background: rgba(59, 130, 246, 0.08);
      }

      .alert-title {
        font-weight: 600;
        margin-bottom: 0.2rem;
      }

      .muted {
        color: var(--muted);
        font-size: 0.85rem;
      }

      .grid-two {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.8rem;
      }

      .grid-three {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      .stat-box {
        background: rgba(15, 23, 42, 0.7);
        border-radius: 14px;
        border: 1px solid var(--border);
        padding: 0.9rem 1rem;
      }

      section h3 {
        margin-top: 1.2rem;
        margin-bottom: 0.6rem;
        font-size: 0.95rem;
        color: var(--muted);
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .history-chart {
        margin-top: 1rem;
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 0.9rem 1rem;
      }

      .history-chart svg {
        width: 100%;
        height: 90px;
        display: block;
      }

      .history-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .trend-up {
        color: #34d399;
      }

      .trend-down {
        color: #f87171;
      }

      .list-card.critical {
        border-color: rgba(248, 113, 113, 0.5);
        background: rgba(248, 113, 113, 0.15);
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.5rem;
      }

      .data-table th,
      .data-table td {
        padding: 0.6rem 0.75rem;
        text-align: left;
        border-bottom: 1px solid rgba(148, 163, 184, 0.15);
        font-size: 0.85rem;
      }

      .data-table th {
        color: var(--muted);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        font-size: 0.78rem;
      }

      .data-table tr:nth-child(even) {
        background: rgba(15, 23, 42, 0.35);
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.3rem 0.65rem;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        background: rgba(148, 163, 184, 0.15);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }

      .pill.danger {
        border-color: rgba(248, 113, 113, 0.5);
        background: rgba(248, 113, 113, 0.2);
        color: #fecaca;
      }

      .pill.warn {
        border-color: rgba(250, 204, 21, 0.4);
        background: rgba(250, 204, 21, 0.18);
        color: #fef08a;
      }

      .pill.success {
        border-color: rgba(74, 222, 128, 0.4);
        background: rgba(74, 222, 128, 0.2);
        color: #bbf7d0;
      }

      .warning-text {
        color: #facc15;
        font-size: 0.82rem;
      }

      .grid-auto {
        display: grid;
        gap: 0.8rem;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .list-group {
        display: grid;
        gap: 0.9rem;
      }

      .list-card {
        background: rgba(15, 23, 42, 0.7);
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 0.9rem 1rem;
        display: grid;
        gap: 0.3rem;
      }

      .list-card strong {
        font-size: 1rem;
      }

      .badge-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .badge {
        background: rgba(59, 130, 246, 0.18);
        border: 1px solid rgba(59, 130, 246, 0.4);
        border-radius: 999px;
        padding: 0.3rem 0.75rem;
        font-size: 0.8rem;
        letter-spacing: 0.05em;
      }

      .badge.critical {
        background: rgba(248, 113, 113, 0.18);
        border-color: rgba(248, 113, 113, 0.5);
      }

      .insight-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 0.8rem;
      }

      .insight-list li {
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.6);
        border-radius: 12px;
        padding: 0.85rem 1rem;
        line-height: 1.4;
      }

      .leaderboard {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 0.6rem;
      }

      .leaderboard li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px dashed rgba(255, 255, 255, 0.12);
        padding-bottom: 0.3rem;
      }

      .metric-large {
        font-size: 1.8rem;
        font-weight: 700;
      }

      .subtext {
        font-size: 0.8rem;
        color: var(--muted);
      }

      footer {
        padding: 1.1rem 2rem;
        text-align: right;
        color: var(--muted);
        border-top: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.7);
      }

      @media (max-width: 768px) {
        header {
          flex-direction: column;
          gap: 1rem;
          text-align: center;
        }

        main {
          padding: 1.4rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <h1>Project Sentinel</h1>
        <p class="muted">Customer Experience Operations Command Center</p>
      </div>
      <div class="status-chip">
        <span class="health-indicator health-optimal"></span>
        <span id="system-status">Live</span>
      </div>
    </header>

    <main>
      <section id="overall-section">
        <h2>
          Store Pulse
          <span class="muted" id="last-updated">--</span>
        </h2>
        <div class="grid-three" id="overall-metrics">
          <div class="stat-box">
            <div class="muted">Overall Health</div>
            <div id="overall-health" class="metric-large">--</div>
            <div class="muted" id="system-status-text">--</div>
          </div>

          <div class="stat-box">
            <div class="muted">Total Customers</div>
            <div id="total-customers" style="font-size: 1.4rem; font-weight: 600">--</div>
            <div class="muted">Active stations: <span id="active-stations">--</span></div>
          </div>

          <div class="stat-box">
            <div class="muted">Staffing Recommendation</div>
            <div id="staffing-recommendation" style="font-size: 1rem">--</div>
            <div class="muted">Target per station: <span id="target-per-station">--</span></div>
          </div>
        </div>
        <div class="history-chart">
          <svg id="overall-history-chart" viewBox="0 0 320 90" preserveAspectRatio="none"></svg>
          <div class="history-summary">
            <span id="overall-trend">Trend --</span>
            <span id="overall-load">Load --</span>
          </div>
        </div>
      </section>

      <section>
        <h2>Queue Stations</h2>
        <div class="cards" id="stations"></div>
      </section>

      <section>
        <h2>Staffing Insights</h2>
        <div id="staffing-kpis" class="grid-two"></div>
      </section>

      <section>
        <h2>Critical Alerts</h2>
        <div id="alerts"></div>
      </section>

      <section>
        <h2>Suspicious Checkouts</h2>
        <div id="suspicious"></div>
      </section>

      <section>
        <h2>Correlated Checkouts</h2>
        <div id="correlations"></div>
      </section>

      <section>
        <h2>Detection Feed</h2>
        <div id="detections" class="list-group"></div>
      </section>

      <section id="inventory-section">
        <h2>Inventory Watch</h2>
        <div class="grid-two">
          <div class="stat-box">
            <div class="muted">Shrinkage Value</div>
            <div id="inventory-shrinkage-value" class="metric-large">--</div>
          </div>
          <div class="stat-box">
            <div class="muted">Shrinkage Units</div>
            <div id="inventory-shrinkage-units" class="metric-large">--</div>
          </div>
          <div class="stat-box">
            <div class="muted">Actual Inventory Value</div>
            <div id="inventory-actual-value" class="metric-large">--</div>
            <div class="subtext" id="inventory-expected-value">Expected --</div>
          </div>
        </div>
        <h3>Shrinkage Alerts</h3>
        <div id="inventory-alerts" class="list-group"></div>
        <h3>High-Value Watchlist</h3>
        <div id="inventory-high-value" class="list-group"></div>
        <h3>Top Shrinkage SKUs</h3>
        <div id="inventory-top-shrink"></div>
      </section>

      <section>
        <h2>Operational Insights</h2>
        <ul id="insights" class="insight-list"></ul>
      </section>

      <section>
        <h2>Correlation Radar</h2>
        <div class="grid-two">
          <div class="stat-box">
            <div class="muted">Top Correlated SKUs</div>
            <ul id="correlated-skus" class="leaderboard"></ul>
          </div>
          <div class="stat-box">
            <div class="muted">Stations Under Watch</div>
            <ul id="stations-under-watch" class="leaderboard"></ul>
          </div>
        </div>
        <h3>Recent Correlations</h3>
        <div id="recent-correlations" class="list-group"></div>
      </section>

      <section>
        <h2>Data Feed Health</h2>
        <div class="grid-two">
          <div class="stat-box">
            <div class="muted">Events last minute</div>
            <div id="stream-events-minute" class="metric-large">--</div>
          </div>
          <div class="stat-box">
            <div class="muted">Events per minute</div>
            <div id="stream-events-rate" class="metric-large">--</div>
            <div class="subtext" id="stream-last-event">Last event --</div>
          </div>
        </div>
        <h3>Active Datasets</h3>
        <div id="stream-datasets" class="badge-row"></div>
        <h3>Dataset Throughput</h3>
        <div id="stream-dataset-cards" class="list-group"></div>
        <h3>Stream Reader</h3>
  <div id="stream-reader-status" class="list-group"></div>
  <ul id="stream-warnings" class="insight-list" style="margin-top: 0.8rem"></ul>
      </section>

      <section id="evaluation-section">
        <h2>Pipeline Evaluation</h2>
  <div id="evaluation-cards" class="grid-auto"></div>
        <h3>Exceptions</h3>
        <div id="evaluation-exceptions" class="list-group"></div>
      </section>
    </main>

    <footer>
      Sentinel CX Analytics · Powered by Python standard library & vanilla JS
    </footer>

    <script>
      const apiHost = window.location.hostname || "localhost";
      const API_BASE = `http://${apiHost}:5000`;
      console.info(`[sentinel] dashboard targeting API at ${API_BASE}`);
      const currencyFormatter = new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD",
        maximumFractionDigits: 0,
      });
      const numberFormatter = new Intl.NumberFormat("en-US", {
        maximumFractionDigits: 1,
      });

      function formatSeconds(value) {
        if (value === null || value === undefined || Number.isNaN(value)) return "--";
        const seconds = Number(value);
        if (seconds < 60) return `${numberFormatter.format(seconds)}s`;
        const minutes = seconds / 60;
        if (minutes < 120) return `${numberFormatter.format(minutes)}m`;
        const hours = minutes / 60;
        if (hours < 48) return `${numberFormatter.format(hours)}h`;
        const days = hours / 24;
        return `${numberFormatter.format(days)}d`;
      }

      function formatTimestamp(value) {
        if (!value) return "--";
        try {
          return new Date(value).toLocaleTimeString();
        } catch (err) {
          return value;
        }
      }

      function toTitleCase(value) {
        if (!value) return "";
        return value
          .toString()
          .replace(/_/g, " ")
          .replace(/\b\w/g, (char) => char.toUpperCase());
      }

      function classifyHealth(score) {
        if (score >= 85) return "health-optimal";
        if (score >= 70) return "health-stable";
        if (score >= 50) return "health-at-risk";
        return "health-critical";
      }

      function renderStations(stations) {
        const container = document.getElementById("stations");
        container.innerHTML = "";
        if (!stations || stations.length === 0) {
          container.innerHTML = '<p class="muted">No active stations yet.</p>';
          return;
        }
        stations.forEach((station) => {
          const indicator = classifyHealth(station.health_score || 0);
          const card = document.createElement("div");
          card.className = "station-card";
          card.innerHTML = `
            <div style="display:flex; justify-content: space-between; align-items:center;">
              <div class="station-id">${station.station_id}</div>
              <span class="health-indicator ${indicator}"></span>
            </div>
            <div class="metric"><span>Health score</span><strong>${station.health_score ?? "--"}</strong></div>
            <div class="metric"><span>Queue length</span><span>${station.customer_count ?? "--"} customers</span></div>
            <div class="metric"><span>Dwell time</span><span>${station.average_dwell_time ?? "--"}s</span></div>
            <div class="metric"><span>Service rate</span><span>${station.service_rate ?? "--"}/min</span></div>
            <div class="metric"><span>Status</span><span style="text-transform: capitalize;">${station.status ?? "--"}</span></div>
          `;
          container.appendChild(card);
        });
      }

      function renderAlerts(incidents) {
        const container = document.getElementById("alerts");
        container.innerHTML = "";
        if (!incidents || incidents.length === 0) {
          container.innerHTML = '<p class="muted">No active incidents.</p>';
          return;
        }
        incidents.forEach((incident) => {
          const alert = document.createElement("div");
          alert.className = `alert ${incident.priority || ""}`;
          alert.innerHTML = `
            <div class="alert-title">${incident.message || incident.type}</div>
            <div class="muted">${incident.station_id || "--"} • ${new Date(incident.timestamp).toLocaleTimeString()}</div>
          `;
          container.appendChild(alert);
        });
      }

      function renderStaffing(staffing) {
        const container = document.getElementById("staffing-kpis");
        container.innerHTML = "";
        if (!staffing) {
          container.innerHTML = '<p class="muted">Staffing data will appear once queues are active.</p>';
          return;
        }

        const stats = [
          {
            label: "Active stations",
            value: staffing.active_stations ?? "--",
            note: "Currently serving customers",
          },
          {
            label: "Required stations",
            value: staffing.required_stations ?? "--",
            note: "Needed to meet demand",
          },
          {
            label: "Efficiency ratio",
            value: staffing.efficiency_ratio?.toFixed(2) ?? "--",
            note: "Customers vs. target",
          },
        ];

        stats.forEach((item) => {
          const box = document.createElement("div");
          box.className = "stat-box";
          box.innerHTML = `
            <div class="muted">${item.label}</div>
            <div style="font-size: 1.5rem; font-weight: 600">${item.value}</div>
            <div class="muted">${item.note}</div>
          `;
          container.appendChild(box);
        });
      }

      function renderCorrelations(correlations) {
        // correlations may include recent_correlations, top_correlated_skus, stations_under_watch
        const container = document.getElementById("correlations");
        container.innerHTML = "";
        const recents = (correlations && correlations.recent_correlations) || correlations?.recent || [];
        const summaryList = recents.slice(0, 6);
        if (summaryList.length === 0) {
          container.innerHTML = '<p class="muted">No recent correlated checkouts.</p>';
        } else {
          summaryList.forEach((event) => {
            const card = document.createElement("div");
            card.className = "alert low";
            card.innerHTML = `
              <div class="alert-title">${event.sku || "SKU"} • ${event.station_id || "--"}</div>
              <div class="muted">Confidence ${(event.confidence ?? 0).toFixed(2)} — RFID ${event.rfid_matches ?? 0} / Vision ${event.vision_matches ?? 0}</div>
              <div class="muted">${new Date(event.timestamp || Date.now()).toLocaleTimeString()}</div>
            `;
            container.appendChild(card);
          });
        }

        // leaderboards and recent correlations details
        renderLeaderboard(document.getElementById("correlated-skus"), correlations?.top_correlated_skus || [], (entry) => ({
          label: Array.isArray(entry) ? entry[0] : entry.sku || "SKU",
          value: Array.isArray(entry) ? entry[1] : entry.count || entry.score || "--",
        }));

        renderLeaderboard(document.getElementById("stations-under-watch"), correlations?.stations_under_watch || [], (entry) => ({
          label: Array.isArray(entry) ? entry[0] : entry.station_id || "station",
          value: Array.isArray(entry) ? entry[1] : entry.count || "--",
        }));

        const recentContainer = document.getElementById("recent-correlations");
        recentContainer.innerHTML = "";
        const recentsList = correlations?.recent_correlations || correlations?.recent || [];
        if (!recentsList.length) {
          recentContainer.innerHTML = '<p class="muted">No recent correlated checkouts.</p>';
          return;
        }
        recentsList.slice(-5).reverse().forEach((item) => {
          const card = document.createElement("div");
          card.className = "list-card";
          card.innerHTML = `
            <strong>${item.sku || "SKU"} @ ${item.station_id || "--"}</strong>
            <span class="muted">Confidence ${(item.confidence ?? 0).toFixed(2)} · RFID ${item.rfid_matches ?? 0} · Vision ${item.vision_matches ?? 0}</span>
            <span class="muted">${new Date(item.timestamp || Date.now()).toLocaleTimeString()}</span>
          `;
          recentContainer.appendChild(card);
        });
      }

      function renderDetections(events) {
        const container = document.getElementById("detections");
        container.innerHTML = "";
        if (!events || events.length === 0) {
          container.innerHTML = '<p class="muted">No detections received.</p>';
          return;
        }

        const recent = events.slice(-6).reverse();
        recent.forEach((event) => {
          const card = document.createElement("div");
          card.className = "list-card";
          const details = event.details || {};
          const type = toTitleCase(details.type || details.event_type || "Detection");
          const confidenceRaw = details.confidence;
          const confidenceValue =
            typeof confidenceRaw === "number" ? confidenceRaw : Number.parseFloat(confidenceRaw);
          const hasConfidence = Number.isFinite(confidenceValue);
          const evidence = details.evidence || details.attributes;
          let evidenceSummary = "";
          if (evidence && typeof evidence === "object") {
            evidenceSummary = Object.entries(evidence)
              .slice(0, 3)
              .map(([key, value]) => `${key}: ${value}`)
              .join(", ");
          }
          const notes = details.notes || details.message || "";
          card.innerHTML = `
            <div style="display:flex; justify-content: space-between; align-items:center; gap: 0.6rem;">
              <strong>${type}</strong>
              ${hasConfidence ? `<span class="badge">${confidenceValue.toFixed(2)}</span>` : ""}
            </div>
            <span class="muted">${event.station_id || "--"} • ${new Date(event.timestamp || Date.now()).toLocaleTimeString()}</span>
            ${notes ? `<span>${notes}</span>` : ""}
            ${evidenceSummary ? `<span class="muted">${evidenceSummary}</span>` : ""}
          `;
          container.appendChild(card);
        });
      }

      function renderSuspicious(events) {
        const container = document.getElementById("suspicious");
        container.innerHTML = "";
        if (!events || events.length === 0) {
          container.innerHTML = '<p class="muted">All checkouts look healthy.</p>';
          return;
        }
        events.forEach((event) => {
          const alert = document.createElement("div");
          alert.className = "alert high";
          alert.innerHTML = `
            <div class="alert-title">SKU ${event.sku || "??"} @ ${event.station_id}</div>
            <div class="muted">${(event.reasons || []).join(", ")}</div>
            <div class="muted">Confidence: ${(event.confidence ?? 0).toFixed(2)}</div>
          `;
          container.appendChild(alert);
        });
      }

      function renderInventory(report) {
        const shrinkValue = report?.summary?.total_shrinkage_value;
        const shrinkUnits = report?.summary?.total_shrinkage_units || report?.summary?.shrinkage_units;
        const actualValue = report?.summary?.overall_actual_value;
        const expectedValue = report?.summary?.overall_expected_value;

        document.getElementById("inventory-shrinkage-value").textContent =
          typeof shrinkValue === "number" ? currencyFormatter.format(shrinkValue) : "--";
        document.getElementById("inventory-shrinkage-units").textContent =
          typeof shrinkUnits === "number" ? numberFormatter.format(shrinkUnits) : "--";
        document.getElementById("inventory-actual-value").textContent =
          typeof actualValue === "number" ? currencyFormatter.format(actualValue) : "--";
        document.getElementById("inventory-expected-value").textContent =
          typeof expectedValue === "number"
            ? `Expected ${currencyFormatter.format(expectedValue)}`
            : "Expected --";

        const alertsContainer = document.getElementById("inventory-alerts");
        const watchContainer = document.getElementById("inventory-high-value");
        const shrinkContainer = document.getElementById("inventory-top-shrink");
        alertsContainer.innerHTML = "";
        watchContainer.innerHTML = "";
        shrinkContainer.innerHTML = "";

        if (!report) {
          alertsContainer.innerHTML = '<p class="muted">Awaiting inventory snapshot.</p>';
          watchContainer.innerHTML = '<p class="muted">Awaiting inventory snapshot.</p>';
          shrinkContainer.innerHTML = '<p class="muted">Awaiting inventory snapshot.</p>';
          return;
        }

        const shrinkageAlerts = report.alerts?.shrinkage || [];
        if (shrinkageAlerts.length === 0) {
          alertsContainer.innerHTML = '<p class="muted">No shrinkage alerts at the moment.</p>';
        } else {
          shrinkageAlerts.slice(0, 5).forEach((alert) => {
            const card = document.createElement("div");
            card.className = "list-card";
            const priorityBadge = `<span class="badge ${alert.priority === "high" ? "critical" : ""}">${
              toTitleCase(alert.priority || "medium")
            }</span>`;
            card.innerHTML = `
              <div style="display:flex; justify-content: space-between; align-items:center; gap: 0.5rem;">
                <strong>${alert.product_name || alert.sku}</strong>
                ${priorityBadge}
              </div>
              <span class="muted">SKU ${alert.sku}</span>
              <span class="muted">Shrinkage ${alert.shrinkage_units || alert.delta_units} units · ${currencyFormatter.format(
                alert.shrinkage_value || alert.delta_value || 0
              )}</span>
            `;
            alertsContainer.appendChild(card);
          });
        }

        const highValue = report.alerts?.high_value_watch || [];
        if (highValue.length === 0) {
          watchContainer.innerHTML = '<p class="muted">All high-value items are sufficiently stocked.</p>';
        } else {
          highValue.slice(0, 5).forEach((item) => {
            const card = document.createElement("div");
            card.className = "list-card";
            card.innerHTML = `
              <strong>${item.product_name || item.sku}</strong>
              <span class="muted">SKU ${item.sku} · On hand ${item.units_on_hand}</span>
              <span class="muted">Unit price ${currencyFormatter.format(item.unit_price || 0)}</span>
              <span class="muted">${item.message || "Monitor closely"}</span>
            `;
            watchContainer.appendChild(card);
          });
        }

        const perSku = report.skus || {};
        const shrinkRows = Object.entries(perSku)
          .map(([sku, stats]) => ({ sku, ...stats }))
          .filter((row) => Number.isFinite(row.delta_units) && row.delta_units > 0)
          .sort((a, b) => (b.delta_value ?? 0) - (a.delta_value ?? 0))
          .slice(0, 8);

        if (shrinkRows.length === 0) {
          shrinkContainer.innerHTML = '<p class="muted">No shrinkage detected in the monitored SKUs.</p>';
        } else {
          const table = document.createElement("table");
          table.className = "data-table";
          table.innerHTML = `
            <thead>
              <tr>
                <th>SKU</th>
                <th>Expected</th>
                <th>Actual</th>
                <th>Delta</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              ${shrinkRows
                .map((row) => {
                  const value = typeof row.delta_value === "number" ? currencyFormatter.format(row.delta_value) : "--";
                  return `
                    <tr>
                      <td>${row.product_name || row.sku}</td>
                      <td>${row.expected_after_sales ?? "--"}</td>
                      <td>${row.actual ?? "--"}</td>
                      <td>${row.delta_units ?? "--"}</td>
                      <td>${value}</td>
                    </tr>
                  `;
                })
                .join("")}
            </tbody>
          `;
          shrinkContainer.appendChild(table);
        }
      }

      function renderInsights(insights) {
        const container = document.getElementById("insights");
        container.innerHTML = "";
        if (!insights || insights.length === 0) {
          const empty = document.createElement("li");
          empty.className = "muted";
          empty.textContent = "No additional insights yet.";
          container.appendChild(empty);
          return;
        }

        insights
          .slice(-5)
          .reverse()
          .forEach((insight) => {
            const li = document.createElement("li");
            if (typeof insight === "string") {
              li.textContent = insight;
            } else {
              const primary =
                insight.insight || insight.message || insight.summary || JSON.stringify(insight, null, 0);
              const analyst = insight.analyst || insight.owner || "";
              const focus = insight.focus || insight.category || "";
              const timestamp = insight.timestamp ? new Date(insight.timestamp).toLocaleTimeString() : "";
              li.innerHTML = `
                <strong>${primary}</strong>
                <div class="subtext">${[analyst, focus].filter(Boolean).join(" · ")}</div>
                ${timestamp ? `<div class="subtext">${timestamp}</div>` : ""}
              `;
            }
            container.appendChild(li);
          });
      }

      function renderLeaderboard(listElement, entries, formatter) {
        if (!listElement) return;
        listElement.innerHTML = "";
        if (!entries || entries.length === 0) {
          const item = document.createElement("li");
          item.className = "muted";
          item.textContent = "No data";
          listElement.appendChild(item);
          return;
        }
        entries.forEach((entry) => {
          const li = document.createElement("li");
          const { label, value } = formatter(entry);
          li.innerHTML = `<span>${label}</span><span>${value}</span>`;
          listElement.appendChild(li);
        });
      }

      function renderOverallHistory(history) {
        const svg = document.getElementById("overall-history-chart");
        const trendEl = document.getElementById("overall-trend");
        const loadEl = document.getElementById("overall-load");
        if (!svg || !trendEl || !loadEl) return;

        if (!history || !Array.isArray(history.scores) || history.scores.length < 2) {
          svg.innerHTML = '<text x="12" y="50" fill="#94a3b8">Waiting for history…</text>';
          trendEl.textContent = "Trend --";
          trendEl.classList.remove("trend-up", "trend-down");
          loadEl.textContent = "Load --";
          return;
        }

        const scores = history.scores.slice(-40);
        const loads = Array.isArray(history.loads) ? history.loads.slice(-40) : [];
        const width = 320;
        const height = 90;
        const leftPad = 6;
        const rightPad = 6;
        const usableWidth = width - leftPad - rightPad;
        const minScore = Math.min(...scores, 0);
        const maxScore = Math.max(...scores, 100);
        const range = Math.max(maxScore - minScore, 1);
        const pointCount = scores.length;
        const points = scores.map((score, idx) => {
          const ratio = pointCount === 1 ? 0 : idx / (pointCount - 1);
          const x = leftPad + ratio * usableWidth;
          const y = height - ((score - minScore) / range) * (height - 12) - 6;
          return `${x.toFixed(1)},${y.toFixed(1)}`;
        });

        const baselineScore = Math.min(Math.max(100, minScore), maxScore);
        const baseline =
          height - ((baselineScore - minScore) / range) * (height - 12) - 6;

        svg.innerHTML = `
          <polyline points="${points.join(" ")}" fill="none" stroke="#38bdf8" stroke-width="2.5" stroke-linecap="round" />
          <line x1="${leftPad}" y1="${baseline.toFixed(1)}" x2="${width - rightPad}" y2="${baseline.toFixed(1)}" stroke="rgba(148,163,184,0.25)" stroke-dasharray="4 5" />
        `;

        const delta = scores[scores.length - 1] - scores[0];
        trendEl.textContent = `Trend ${delta >= 0 ? "+" : ""}${delta.toFixed(1)} pts`;
        trendEl.classList.remove("trend-up", "trend-down");
        trendEl.classList.add(delta >= 0 ? "trend-up" : "trend-down");

        const latestLoad = loads.length ? loads[loads.length - 1] : null;
        const avgWindow = loads.slice(-6);
        const avgLoad = avgWindow.length
          ? avgWindow.reduce((acc, value) => acc + (value ?? 0), 0) / avgWindow.length
          : null;
        loadEl.textContent =
          latestLoad !== null && latestLoad !== undefined
            ? `Load ${latestLoad} customers • avg ${avgLoad !== null ? avgLoad.toFixed(1) : "--"}`
            : "Load --";
      }

      function renderStreamHealth(health) {
        const eventsLastMinute = Number.isFinite(health?.events_last_minute) ? health.events_last_minute : null;
        const eventsPerMinute = Number.isFinite(health?.events_per_minute) ? health.events_per_minute : null;
        const lastEventAgo = Number.isFinite(health?.last_event_seconds_ago) ? health.last_event_seconds_ago : null;
        const datasets = Array.isArray(health?.datasets)
          ? health.datasets
          : Array.isArray(health?.active_datasets)
          ? health.active_datasets.map((name) => ({ dataset: name }))
          : [];

        document.getElementById("stream-events-minute").textContent =
          eventsLastMinute !== null ? eventsLastMinute.toString() : "--";
        document.getElementById("stream-events-rate").textContent =
          eventsPerMinute !== null ? numberFormatter.format(eventsPerMinute) : "--";
        document.getElementById("stream-last-event").textContent =
          lastEventAgo !== null ? `Last event ${formatSeconds(lastEventAgo)} ago` : "Last event --";

        const datasetBadges = document.getElementById("stream-datasets");
        datasetBadges.innerHTML = "";
        if (!datasets.length) {
          datasetBadges.innerHTML = '<span class="muted">Awaiting stream activity.</span>';
        } else {
          datasets.forEach((dataset) => {
            const badge = document.createElement("span");
            const stale = Number.isFinite(dataset.last_seen_seconds_ago) && dataset.last_seen_seconds_ago > 120;
            badge.className = `badge${stale ? " critical" : ""}`;
            badge.textContent = (dataset.dataset || dataset).toString().toUpperCase();
            datasetBadges.appendChild(badge);
          });
        }

        const datasetCards = document.getElementById("stream-dataset-cards");
        datasetCards.innerHTML = "";
        if (!datasets.length) {
          datasetCards.innerHTML = '<p class="muted">No dataset telemetry yet.</p>';
        } else {
          datasets
            .slice()
            .sort((a, b) => (b.events_last_minute ?? 0) - (a.events_last_minute ?? 0))
            .forEach((dataset) => {
              const stale = Number.isFinite(dataset.last_seen_seconds_ago) && dataset.last_seen_seconds_ago > 180;
              const card = document.createElement("div");
              card.className = `list-card${stale ? " critical" : ""}`;
              const statusClass = stale ? "danger" : "success";
              card.innerHTML = `
                <div style="display:flex; justify-content: space-between; align-items:center; gap: 0.4rem;">
                  <strong>${(dataset.dataset || "dataset").toString().toUpperCase()}</strong>
                  <span class="pill ${statusClass}">${stale ? "Stale" : "Healthy"}</span>
                </div>
                <span class="muted">Last seen ${formatSeconds(dataset.last_seen_seconds_ago)} ago (${formatTimestamp(dataset.last_seen)})</span>
                <span class="muted">Throughput: ${dataset.events_last_minute ?? 0} / min · ${dataset.events_last_15_minutes ?? 0} in 15m</span>
              `;
              datasetCards.appendChild(card);
            });
        }

        const readerContainer = document.getElementById("stream-reader-status");
        readerContainer.innerHTML = "";
        const reader = health?.reader_status || {};
        const readerCard = document.createElement("div");
        const connected = Boolean(reader.connected);
        readerCard.className = "list-card";
        readerCard.innerHTML = `
          <div style="display:flex; justify-content: space-between; align-items:center; gap: 0.4rem;">
            <strong>${connected ? "Stream reader connected" : "Stream reader offline"}</strong>
            <span class="pill ${connected ? "success" : "danger"}">${connected ? "Connected" : "Offline"}</span>
          </div>
          <span class="muted">Processed events: ${reader.processed_events ?? 0}</span>
          <span class="muted">Last heartbeat ${formatSeconds(reader.seconds_since_heartbeat ?? null)} ago (${formatTimestamp(
            reader.last_heartbeat
          )})</span>
          ${reader.latency_ms !== undefined && reader.latency_ms !== null ? `<span class="muted">Latency ${numberFormatter.format(reader.latency_ms)} ms</span>` : ""}
          ${reader.notes ? `<span>${reader.notes}</span>` : ""}
        `;
        readerContainer.appendChild(readerCard);

        const warnings = document.getElementById("stream-warnings");
        warnings.innerHTML = "";
        const staleDatasets = datasets.filter((dataset) => Number.isFinite(dataset.last_seen_seconds_ago) && dataset.last_seen_seconds_ago > 180);
        if (staleDatasets.length) {
          staleDatasets.forEach((dataset) => {
            const li = document.createElement("li");
            li.className = "warning-text";
            li.textContent = `${(dataset.dataset || dataset).toString().toUpperCase()} idle for ${formatSeconds(
              dataset.last_seen_seconds_ago
            )}. Investigate ingestion.`;
            warnings.appendChild(li);
          });
        } else if (!datasets.length) {
          const li = document.createElement("li");
          li.className = "muted";
          li.textContent = "Waiting for stream activity.";
          warnings.appendChild(li);
        } else {
          const li = document.createElement("li");
          li.className = "muted";
          li.textContent = "Stream telemetry within healthy thresholds.";
          warnings.appendChild(li);
        }
      }

      function renderEvaluation(metrics) {
        const cards = document.getElementById("evaluation-cards");
        const exceptions = document.getElementById("evaluation-exceptions");
        if (!cards || !exceptions) return;

        cards.innerHTML = "";
        exceptions.innerHTML = "";

        if (!metrics) {
          cards.innerHTML = '<div class="stat-box"><div class="muted">Evaluation</div><div class="metric-large">--</div><div class="muted">Run evaluation to populate metrics.</div></div>';
          const li = document.createElement("div");
          li.className = "muted";
          li.textContent = "No evaluation results ingested yet.";
          exceptions.appendChild(li);
          return;
        }

        const stats = [
          {
            label: "Precision",
            value: Number.isFinite(metrics.precision) ? (metrics.precision * 100).toFixed(1) + "%" : "--",
            note: "Share of predicted events that were correct",
          },
          {
            label: "Recall",
            value: Number.isFinite(metrics.recall) ? (metrics.recall * 100).toFixed(1) + "%" : "--",
            note: "Coverage of reference events",
          },
          {
            label: "F1 Score",
            value: Number.isFinite(metrics.f1) ? (metrics.f1 * 100).toFixed(1) + "%" : "--",
            note: `Support ${metrics.support ?? "--"} events`,
          },
        ];

        stats.forEach((stat) => {
          const card = document.createElement("div");
          card.className = "stat-box";
          card.innerHTML = `
            <div class="muted">${stat.label}</div>
            <div class="metric-large">${stat.value}</div>
            <div class="muted">${stat.note}</div>
          `;
          cards.appendChild(card);
        });

        const timestamp = metrics.timestamp ? formatTimestamp(metrics.timestamp) : "--";
        const summaryCard = document.createElement("div");
        summaryCard.className = "stat-box";
        summaryCard.innerHTML = `
          <div class="muted">Last evaluated</div>
          <div style="font-size:1.1rem; font-weight:600">${timestamp}</div>
          <div class="muted">Fields: ${(metrics.fields || []).join(", ") || "default"}</div>
        `;
        cards.appendChild(summaryCard);

        const fp = Array.isArray(metrics.false_positives) ? metrics.false_positives : [];
        const fn = Array.isArray(metrics.false_negatives) ? metrics.false_negatives : [];

        if (fp.length === 0 && fn.length === 0) {
          const li = document.createElement("div");
          li.className = "muted";
          li.textContent = "No anomalies detected in evaluation run.";
          exceptions.appendChild(li);
          return;
        }

        const buildList = (title, items, tone) => {
          if (!items.length) {
            return;
          }
          const card = document.createElement("div");
          card.className = "list-card";
          card.innerHTML = `<strong>${title}</strong>`;
          items.slice(0, 5).forEach((item) => {
            const span = document.createElement("span");
            span.className = tone === "warn" ? "warning-text" : "muted";
            span.textContent = Array.isArray(item) ? item.join(" • ") : JSON.stringify(item);
            card.appendChild(span);
          });
          if (items.length > 5) {
            const more = document.createElement("span");
            more.className = "muted";
            more.textContent = `+${items.length - 5} additional`; 
            card.appendChild(more);
          }
          exceptions.appendChild(card);
        };

        buildList("False positives", fp, "warn");
        buildList("False negatives", fn, "warn");
      }

      async function refreshDashboard() {
        try {
          const response = await fetch(`${API_BASE}/api/dashboard`);
          if (!response.ok) throw new Error("Dashboard unavailable");
          const data = await response.json();
          const queue = data.queue || {};
          document.getElementById("last-updated").textContent = new Date(data.timestamp || Date.now()).toLocaleTimeString();
          document.getElementById("overall-health").textContent = `${queue.overall_health_score ?? "--"}`;
          document.getElementById("system-status-text").textContent = data.system_status ?? "--";
          document.getElementById("total-customers").textContent = queue.staffing?.total_customers ?? "--";
          document.getElementById("active-stations").textContent = queue.staffing?.active_stations ?? "--";
          document.getElementById("staffing-recommendation").textContent = queue.staffing?.recommendation || "--";
          document.getElementById("target-per-station").textContent = queue.staffing?.target_per_station ?? "--";

          renderStations(queue.stations || []);
          renderStaffing(queue.staffing || null);
          renderCorrelations(data.correlations || {});
          renderInventory(data.inventory || null);
          renderInsights(data.enriched_insights || []);
          renderOverallHistory(queue.overall_history || null);
          renderStreamHealth({ ...(data.stream_health || {}), reader_status: data.stream_reader || (data.stream_health?.reader_status ?? {}) });
          renderEvaluation(data.evaluation_metrics || null);
        } catch (error) {
          console.error(error);
          document.getElementById("system-status").textContent = "Offline";
        }
      }

      async function refreshAlerts() {
        try {
          const response = await fetch(`${API_BASE}/api/alerts`);
          if (!response.ok) throw new Error("Alert feed unavailable");
          const data = await response.json();
          renderAlerts(data.queue_incidents || []);
          renderDetections(data.detection_events || []);
          renderSuspicious(data.suspicious_checkouts || []);
        } catch (error) {
          console.error(error);
        }
      }

      refreshDashboard();
      refreshAlerts();
      setInterval(refreshDashboard, 3000);
      setInterval(refreshAlerts, 3000);
    </script>
  </body>
</html>
